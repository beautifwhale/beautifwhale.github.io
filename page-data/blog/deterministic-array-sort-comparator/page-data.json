{"componentChunkName":"component---src-templates-post-js","path":"/blog/deterministic-array-sort-comparator/","result":{"data":{"site":{"siteMetadata":{"title":"daithimorton.github.io üêã","siteUrl":"https://daithimorton.github.io"}},"markdownRemark":{"id":"6d6f1300-8875-5476-9ea8-b1b753e9930f","excerpt":"When using Array.sort() make sure your comparator function is deterministic. It should always return the same value for the same inputs, even if the argument order changes.","html":"<blockquote>\n<p>When using Array.sort() make sure your comparator function is deterministic. It should always return the same value for the same inputs, even if the argument order changes.</p>\n</blockquote>\n<!-- end -->\n<p>In NodeJS version 11 the <a href=\"https://github.com/nodejs/node/pull/22754\" target=\"_blank\" rel=\"noreferrer noopener\">v8 engine was updated to version 7.0</a>. One of the issues that was fixed in this release was a move to a <a href=\"https://bugs.chromium.org/p/v8/issues/detail?id=90\" target=\"_blank\" rel=\"noreferrer noopener\">stable sorting algorithm</a>. You read more about sorting in v8 <a href=\"https://v8.dev/blog/array-sort\" target=\"_blank\" rel=\"noreferrer noopener\">here</a>.</p>\n<blockquote>\n<p>Previously, V8 used an unstable QuickSort for arrays with more than 10 elements. Now, we use the stable TimSort algorithm. </p>\n<ul>\n<li>Mathias Bynens <a href=\"https://twitter.com/mathias/status/1036626116654637057\" target=\"_blank\" rel=\"noreferrer noopener\">https://twitter.com/mathias/status/1036626116654637057</a></li>\n</ul>\n</blockquote>\n<p>This update changed the argument order of the <code class=\"language-text\">Array.sort()</code> comparator function. </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// previously NodeJS 10</span>\nArray<span class=\"token punctuation\">.</span><span class=\"token function\">sort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// compare a and b</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// now NodeJS 12</span>\nArray<span class=\"token punctuation\">.</span><span class=\"token function\">sort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">b<span class=\"token punctuation\">,</span> a</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// compare a and b</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Notice <code class=\"language-text\">a</code> and <code class=\"language-text\">b</code> have switched, if you relied on the value of <code class=\"language-text\">a</code> being first in the argument order it is now second. I‚Äôve recreated the bug I encountered below.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> numbersArray <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">22</span><span class=\"token punctuation\">,</span> <span class=\"token number\">34</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">104</span><span class=\"token punctuation\">,</span> <span class=\"token number\">76</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">var</span> result <span class=\"token operator\">=</span> numbersArray<span class=\"token punctuation\">.</span><span class=\"token function\">sort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> a <span class=\"token operator\">-</span> b<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">22</span><span class=\"token punctuation\">,</span> <span class=\"token number\">34</span><span class=\"token punctuation\">,</span> <span class=\"token number\">76</span><span class=\"token punctuation\">,</span> <span class=\"token number\">104</span> <span class=\"token punctuation\">]</span></code></pre></div>\n<p>If you are sorting a simple array of numbers then everything should be fine. You can use the <code class=\"language-text\">-</code> operator to provide a nice deterministic comparator function. But if your array elements are a little more complex and you are using a mix of JavaScript operators to resolve your sorting, you may be in trouble.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> objectArray <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'winston'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">22</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>id<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'winston'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">22</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>id<span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'jess'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>id<span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'nick'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">104</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>id<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'cece'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">76</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">var</span> result <span class=\"token operator\">=</span> objectArray<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>    \n    <span class=\"token comment\">// sort by name, if names are equal sort by age</span>\n    <span class=\"token comment\">// else no change to sort order</span>\n    <span class=\"token keyword\">return</span> a<span class=\"token punctuation\">.</span>name <span class=\"token operator\">></span> b<span class=\"token punctuation\">.</span>name <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> b<span class=\"token punctuation\">.</span>name <span class=\"token operator\">&amp;&amp;</span> a<span class=\"token punctuation\">.</span>age <span class=\"token operator\">></span> b<span class=\"token punctuation\">.</span>age<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// NodeJS 10</span>\n<span class=\"token punctuation\">[</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'winston'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">22</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ! ORDER CHANGED</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'winston'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">22</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'nick'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">104</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'jess'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'cece'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">76</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\">// NodeJS 12</span>\n<span class=\"token punctuation\">[</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'winston'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">22</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'winston'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">22</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'nick'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">104</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'jess'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'cece'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">76</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">]</span></code></pre></div>\n<p>The example above shows a comparator function for sorting an array of objects. The intended result is as follows:</p>\n<ul>\n<li>Sort by name</li>\n<li>If names are equal, sort by age</li>\n<li>Else no change to sort order</li>\n</ul>\n<p>We can see that in NodeJS 12 all is fine, the array is sorted as intended, and specifically when the <code class=\"language-text\">name</code> and <code class=\"language-text\">age</code> values are the same there is no change to the original order of the elements. Great!. But now if we look at the result when this code is run in NodeJS 10, we can see that when the <code class=\"language-text\">name</code> and <code class=\"language-text\">age</code> values are equal, the sort order is affected.</p>\n<p>The bug here is that when the <code class=\"language-text\">name</code> values are equal the comparator function resolves with either <code class=\"language-text\">-1</code> or <code class=\"language-text\">1</code>, there is no resolution where <code class=\"language-text\">0</code> is returned. So our function logic has a bug and we should not be relying on the argument order to this function.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> result <span class=\"token operator\">=</span> objectArray<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> b<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> a<span class=\"token punctuation\">.</span>age <span class=\"token operator\">-</span> b<span class=\"token punctuation\">.</span>age\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> b<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span><span class=\"token function\">localeCompare</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// NodeJS 10 + NodeJS 12</span>\n<span class=\"token punctuation\">[</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'winston'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">22</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'winston'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">22</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'nick'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">104</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'jess'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'cece'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">76</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">]</span></code></pre></div>\n<p>A solution to fix this bug is to first check if the names are equal, then sort by age using the <code class=\"language-text\">-</code> operator. And if the names are not equal then using <code class=\"language-text\">localeCompare()</code> will provide the desired return values for our deterministic comparator function.</p>\n<blockquote>\n<p>The localeCompare() method returns a number indicating whether a reference string comes before, or after, or is the same as the given string in sort order.</p>\n</blockquote>\n<h2>Conclusion</h2>\n<p>Working on this bug has reminded me that my application code is like a planet in the Milky Way JavaScript galaxy. There are alot of moving parts that get involved to run my code in the way that I expect. It is easy to forget those layers of complexity and the work that has been done to provide such an acceptable developer experience. Bugs that arise from changes to your development environment are always a little tricky to get to the root of. </p>\n<p>So the next time I‚Äôm working on a weird little bug I‚Äôll be sure to look just a little bit deeper.</p>\n<h2>References</h2>\n<ul>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/sort\" target=\"_blank\" rel=\"noreferrer noopener\">MDN: Array.prototype.sort()</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators\" target=\"_blank\" rel=\"noreferrer noopener\">MDN: Operators</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/localeCompare\" target=\"_blank\" rel=\"noreferrer noopener\">MDN: String.prototype.localeCompare()</a></li>\n<li><a href=\"https://v8.dev/blog/array-sort\" target=\"_blank\" rel=\"noreferrer noopener\">v8.dev ‚ÄúGetting things sorted in V8‚Äù</a></li>\n</ul>","frontmatter":{"title":"Watch out for Array.sort()","bannerCredit":"Photo by Todd Cravens","bannerLink":"https://unsplash.com/photos/lwACYK8ScmA","imageAltText":"blue whale","keywords":"nodejs,sorting","banner":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAEDBP/EABYBAQEBAAAAAAAAAAAAAAAAAAMAAf/aAAwDAQACEAMQAAABdc6QdJMt/8QAGRAAAwEBAQAAAAAAAAAAAAAAAQIRABIh/9oACAEBAAEFAi8COrFj7uBbN//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/ARn/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAgEBPwFn/8QAGBAAAgMAAAAAAAAAAAAAAAAAABESICH/2gAIAQEABj8CYpIyn//EABsQAQADAAMBAAAAAAAAAAAAAAEAESExQWGB/9oACAEBAAE/IVyKeEtYYlnSTa5gxfsWqyf/2gAMAwEAAgADAAAAEI/f/8QAFxEBAQEBAAAAAAAAAAAAAAAAAQAxYf/aAAgBAwEBPxAsZe3/xAAXEQEAAwAAAAAAAAAAAAAAAAAAARFR/9oACAECAQE/EIYp/8QAHRABAAICAgMAAAAAAAAAAAAAAQARIWExQVFxgf/aAAgBAQABPxC3OzeCBMENJa44CK6A8A5fbuCcafI9Qt6FU68SuBbTM//Z","aspectRatio":1.5,"src":"/static/cdf7995e7459cf36a1370bc93c7e8364/94285/banner.jpg","srcSet":"/static/cdf7995e7459cf36a1370bc93c7e8364/49df2/banner.jpg 180w,\n/static/cdf7995e7459cf36a1370bc93c7e8364/6580d/banner.jpg 360w,\n/static/cdf7995e7459cf36a1370bc93c7e8364/94285/banner.jpg 720w,\n/static/cdf7995e7459cf36a1370bc93c7e8364/1920d/banner.jpg 1080w,\n/static/cdf7995e7459cf36a1370bc93c7e8364/c4b07/banner.jpg 1440w,\n/static/cdf7995e7459cf36a1370bc93c7e8364/ccf8f/banner.jpg 3008w","sizes":"(max-width: 720px) 100vw, 720px"}}}},"fields":{"slug":"/deterministic-array-sort-comparator/","readingTime":{"text":"5 min read"}}}},"pageContext":{"slug":"/deterministic-array-sort-comparator/","previous":{"fields":{"slug":"/ac-visitor-center-post-mortem/"},"frontmatter":{"title":"Side project: AC Visitor Center"}},"next":{"fields":{"slug":"/what-is-dev-ux/"},"frontmatter":{"title":"What is DX?"}}}}}